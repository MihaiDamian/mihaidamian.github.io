
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Using Physics in a UIKit Based Application - Code Sushi</title>
  <meta name="author" content="Mihai Damian">

  
  <meta name="description" content="Some of the popular game engines available on iOS like cocos2d and Unity come bundled with physics engines so oftentimes the first thought when you &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.codesushi.net/blog/2013/02/physics-uikit-2">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Code Sushi" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-38317629-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Code Sushi</a></h1>
  
    <h2>tasty bits of code rolled and sliced by Mihai</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.codesushi.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Using Physics in a UIKit Based Application</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-02-05T00:00:00+02:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>12:00 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Some of the popular game engines available on iOS like <a title="cocos2d" href="http://www.cocos2d-iphone.org" target="_blank">cocos2d</a> and <a title="Unity" href="http://unity3d.com" target="_blank">Unity</a> come bundled with physics engines so oftentimes the first thought when you want to add a bit of physics to your app is that you need to use one of the fancy game engines you&rsquo;ve been hearing so much about. In this post I&rsquo;ll walk you through using the <a title="Box2D" href="http://box2d.org" target="_blank">Box2D</a> physics engine without using any game engine or OpenGL.</p>

<p>Let&rsquo;s start with a simple example. Create a single view iPad application project:</p>

<p><img src="http://www.codesushi.net/assets/2013-02-05-physics-uikit-2/images/singleviewapp.png" alt="Choose a project template" />
<img src="http://www.codesushi.net/assets/2013-02-05-physics-uikit-2/images/ipadapp.png" alt="Choose project options" /></p>

<p>Next we need to setup Box2D. The easiest way to do this is via <a title="CocoaPods" href="http://cocoapods.org" target="_blank">CocoaPods</a>. CocoaPods greatly simplifies library dependency management for iOS and OS X projects. If you haven&rsquo;t used it before you need to run the following commands in the terminal to set it up:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="o">[</span>sudo<span class="o">]</span> gem install cocoapods
</span><span class='line'><span class="nv">$ </span>pod setup
</span></code></pre></td></tr></table></div></figure>


<p>Library dependencies are declared in a text file named Podfile which needs to be placed in the same directory as your xcodeproj file. Create the file and paste in the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">platform</span> <span class="ss">:ios</span>
</span><span class='line'><span class="n">pod</span> <span class="s1">&#39;box2d&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 2.3&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This declares you are targeting iOS and want to use the Box2D library using either version 2.3 or any other minor version up to 2.4 but not including 2.4. If you&rsquo;re new to CocoaPods I encourage you to read about the other <a title="dependency declaration options" href="https://github.com/CocoaPods/CocoaPods/wiki/Dependency-declaration-options" target="_blank">dependency declaration options</a> available.</p>

<p>Final step, point your terminal to your Xcode project&rsquo;s folder and run</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>pod install
</span></code></pre></td></tr></table></div></figure>


<p>This command will download the Box2D library and in addition create an Xcode workspace that contains your initial project file and a new Pods project where all your dependencies reside. From this point on you should always use the generated workspace instead of the initial project and you&rsquo;ll be good to go.</p>

<p>Let&rsquo;s move on to the good stuff and lay out some core Box2D concepts we&rsquo;ll be using in this tutorial. Box2D simulates interaction between rigid <em>bodies</em>. Bodies have a position and a set of <em>fixtures</em>. Each fixture links a body with a <em>shape</em> and a few physical properties like mass, friction and &ldquo;bounciness&rdquo;. All bodies are of course part of a <em>world</em> and you could even have multiple worlds if you&rsquo;d so desire. There are a host of other features available in Box2D that I won&rsquo;t be covering in this tutorial. Have a look over the excellent Box2D <a title="Box2D manual" href="http://box2d.org/manual.pdf" target="_blank">manual</a> to see what else is available.</p>

<p>Now the great part about Box2D is that it&rsquo;s completely display agnostic. Its only job is to keep track of your bodies and ensure that everything interacts realistically. This also means it knows nothing of pixels, points or anything like that. Box2D simulates the &ldquo;real world&rdquo; and it&rsquo;s units of measurement are miles, kilograms and seconds. It&rsquo;s up to you to convert UIKit&rsquo;s point based coordinates into something Box2D can handle. There&rsquo;s a catch though: simulating physics on objects of arbitrary size is computationally intensive. To keep things simple Box2D is optimised to handle moving objects of sizes between 0.1 and 10 meters. So considering points and meters equal will not work out very well. Instead we&rsquo;ll use an arbitrary scaling factor to keep bodies within reasonable size.</p>

<p>Let&rsquo;s start by declaring a few functions for converting between points to meters and back:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">static</span> <span class="k">const</span> <span class="n">CGFloat</span> <span class="n">kPointsToMeterRatio</span> <span class="o">=</span> <span class="mf">32.0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">float32</span> <span class="nf">PointsToMeters</span><span class="p">(</span><span class="n">CGFloat</span> <span class="n">points</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">points</span> <span class="o">/</span> <span class="n">kPointsToMeterRatio</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">CGFloat</span> <span class="nf">MetersToPoints</span><span class="p">(</span><span class="n">float32</span> <span class="n">meters</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">meters</span> <span class="o">*</span> <span class="n">kPointsToMeterRatio</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">b2Vec2</span> <span class="nf">CGPointTob2Vec2</span><span class="p">(</span><span class="n">CGPoint</span> <span class="n">point</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">float32</span> <span class="n">x</span> <span class="o">=</span> <span class="n">PointsToMeters</span><span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
</span><span class='line'>    <span class="n">float32</span> <span class="n">y</span> <span class="o">=</span> <span class="n">PointsToMeters</span><span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">b2Vec2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">CGPoint</span> <span class="nf">b2Vec2ToCGPoint</span><span class="p">(</span><span class="n">b2Vec2</span> <span class="n">vector</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">CGFloat</span> <span class="n">x</span> <span class="o">=</span> <span class="n">MetersToPoints</span><span class="p">(</span><span class="n">vector</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
</span><span class='line'>    <span class="n">CGFloat</span> <span class="n">y</span> <span class="o">=</span> <span class="n">MetersToPoints</span><span class="p">(</span><span class="n">vector</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">CGPointMake</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I also included here two convenience functions for converting between CGPoints and Box2D vectors and back.</p>

<p>Next, open up ViewController.m and replace its contents with the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="cp">#import &quot;ViewController.h&quot;</span>
</span><span class='line'><span class="cp">#import &quot;World.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#import &lt;QuartzCore/QuartzCore.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">ViewController</span> <span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">World</span> <span class="o">*</span><span class="n">_world</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">ViewController</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">_world</span> <span class="o">=</span> <span class="p">[[</span><span class="n">World</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFrame:</span><span class="n">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">)];</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">[</span><span class="n">self</span> <span class="n">generateCircles</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">generateCircles</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">CGSize</span> <span class="n">viewSize</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
</span><span class='line'>    <span class="n">CGFloat</span> <span class="n">radius</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
</span><span class='line'>    <span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">UIView</span> <span class="o">*</span><span class="n">circleView</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIView</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFrame:</span><span class="n">CGRectMake</span><span class="p">(</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">viewSize</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">radius</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">radius</span><span class="p">,</span>
</span><span class='line'>                                                                      <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">viewSize</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">radius</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">radius</span><span class="p">,</span>
</span><span class='line'>                                                                      <span class="n">radius</span><span class="p">,</span> <span class="n">radius</span><span class="p">)];</span>
</span><span class='line'>        <span class="n">circleView</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="n">redColor</span><span class="p">];</span>
</span><span class='line'>        <span class="n">circleView</span><span class="p">.</span><span class="n">layer</span><span class="p">.</span><span class="n">cornerRadius</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
</span><span class='line'>        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">view</span> <span class="nl">addSubview:</span><span class="n">circleView</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">_world</span> <span class="nl">addCircleWithView:</span><span class="n">circleView</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The view controller starts by initializing a world object that will handle the interaction with Box2D. The world object is initialized with a frame covering the entire screen. We then create 20 views at random positions on the screen and give them a corner radius to make them look like circles. Finally we pass them to the world object.</p>

<p>Now create a new class called World, do a #import &lt;box2d/Box2D.h&gt; at the top of World.m and add the following ivars to World in the implementation file (which at this point needs to be renamed to World.mm to work with Box2D which is a C++ library):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">b2World</span> <span class="o">*</span><span class="n">_world</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NSMutableArray</span> <span class="o">*</span><span class="n">_circles</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Don&rsquo;t worry right now about what these objects represent &ndash; I&rsquo;ll talk again about them in the next bits of code. If you never mixed Objective-C and C++ code before, remember that it&rsquo;s always worth isolating C++ code and imports of C++/Objective-C++ files in implementation files. This saves you the trouble of renaming .m files to .mm when you import your mixed language code and keeps your compile time as low as possible since Objective-C code compiles faster than Objective-C++ code.</p>

<p>Moving on, declare an initialization method <em>initWithFrame</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">initWithFrame:</span><span class="p">(</span><span class="n">CGRect</span><span class="p">)</span><span class="nv">frame</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">b2Vec2</span> <span class="n">gravity</span><span class="p">(</span><span class="mf">0.0f</span><span class="p">,</span> <span class="mf">10.0f</span><span class="p">);</span>
</span><span class='line'>        <span class="n">_world</span> <span class="o">=</span> <span class="n">new</span> <span class="n">b2World</span><span class="p">(</span><span class="n">gravity</span><span class="p">);</span>
</span><span class='line'>        <span class="n">_circles</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableArray</span> <span class="n">array</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">[</span><span class="n">self</span> <span class="nl">createScreenBoundsForFrame:</span><span class="n">frame</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">self</span> <span class="n">setupAnimationLoop</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code will setup a Box2D world object with gravity defined to be pointing upwards on the Y axis &ndash; meaning objects will appear to be falling from the top to the bottom of our screen. <em>_circle</em> is an array we&rsquo;ll use to keep track of all the bodies we&rsquo;ll be adding to our world. Next we&rsquo;ll create the invisible borders of our screen in <em>createScreenBoundsForFrame:</em> to keep the views from falling off from the screen and finally setup an animation loop to drive everything in <em>setupAniamtionLoop</em>. Here&rsquo;s the code for <em>createScreenBoundsForFrame</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">createScreenBoundsForFrame:</span><span class="p">(</span><span class="n">CGRect</span><span class="p">)</span><span class="nv">frame</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">b2BodyDef</span> <span class="n">screenBoundsDef</span><span class="p">;</span>
</span><span class='line'>    <span class="n">screenBoundsDef</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="mf">0.0f</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">);</span>
</span><span class='line'>    <span class="n">b2Body</span> <span class="o">*</span><span class="n">screenBounds</span> <span class="o">=</span> <span class="n">_world</span><span class="o">-&gt;</span><span class="n">CreateBody</span><span class="p">(</span><span class="o">&amp;</span><span class="n">screenBoundsDef</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">b2Vec2</span> <span class="n">worldEdges</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">worldEdges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2Vec2</span><span class="p">(</span><span class="n">CGPointTob2Vec2</span><span class="p">(</span><span class="n">frame</span><span class="p">.</span><span class="n">origin</span><span class="p">));</span>
</span><span class='line'>    <span class="n">worldEdges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2Vec2</span><span class="p">(</span><span class="n">CGPointTob2Vec2</span><span class="p">(</span><span class="n">CGPointMake</span><span class="p">(</span><span class="n">CGRectGetMinX</span><span class="p">(</span><span class="n">frame</span><span class="p">),</span> <span class="n">CGRectGetMaxY</span><span class="p">(</span><span class="n">frame</span><span class="p">))));</span>
</span><span class='line'>    <span class="n">worldEdges</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2Vec2</span><span class="p">(</span><span class="n">CGPointTob2Vec2</span><span class="p">(</span><span class="n">CGPointMake</span><span class="p">(</span><span class="n">CGRectGetMaxX</span><span class="p">(</span><span class="n">frame</span><span class="p">),</span> <span class="n">CGRectGetMaxY</span><span class="p">(</span><span class="n">frame</span><span class="p">))));</span>
</span><span class='line'>    <span class="n">worldEdges</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2Vec2</span><span class="p">(</span><span class="n">CGPointTob2Vec2</span><span class="p">(</span><span class="n">CGPointMake</span><span class="p">(</span><span class="n">CGRectGetMaxX</span><span class="p">(</span><span class="n">frame</span><span class="p">),</span> <span class="n">CGRectGetMinY</span><span class="p">(</span><span class="n">frame</span><span class="p">))));</span>
</span><span class='line'>    <span class="n">worldEdges</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2Vec2</span><span class="p">(</span><span class="n">CGPointTob2Vec2</span><span class="p">(</span><span class="n">frame</span><span class="p">.</span><span class="n">origin</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">b2ChainShape</span> <span class="n">worldShape</span><span class="p">;</span>
</span><span class='line'>    <span class="n">worldShape</span><span class="p">.</span><span class="n">CreateChain</span><span class="p">(</span><span class="n">worldEdges</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span><span class='line'>    <span class="n">screenBounds</span><span class="o">-&gt;</span><span class="n">CreateFixture</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">worldShape</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here you can see a <em>screenBounds</em> body object being created. Bodies are always instantiated using the Box2D world object that will also keep track and memory manage them. Also notice how the body is created from a body definition object. This allows multiple bodies to be instantiated using the same defining properties. Next we create a chain shape that spans the left, bottom, right and upper edge of the input frame. This is a special type of shape that doesn&rsquo;t have a width and is used mostly for defining boundaries. Finally the shape is bounded to the body using a fixture.</p>

<p>Before looking at the animation loop let&rsquo;s introduce the function that will map UIViews to Box2D bodies:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">addCircleWithView:</span><span class="p">(</span><span class="n">UIView</span><span class="o">*</span><span class="p">)</span><span class="nv">view</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">NSAssert</span><span class="p">(</span><span class="n">view</span><span class="p">.</span><span class="n">superview</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">,</span> <span class="s">@&quot;The view parameter is not part of a view hierarchy&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">b2BodyDef</span> <span class="n">bodyDef</span><span class="p">;</span>
</span><span class='line'>    <span class="n">bodyDef</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">b2_dynamicBody</span><span class="p">;</span>
</span><span class='line'>    <span class="n">bodyDef</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">CGPointTob2Vec2</span><span class="p">(</span><span class="n">view</span><span class="p">.</span><span class="n">center</span><span class="p">);</span>
</span><span class='line'>    <span class="n">b2Body</span> <span class="o">*</span><span class="n">circle</span> <span class="o">=</span> <span class="n">_world</span><span class="o">-&gt;</span><span class="n">CreateBody</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bodyDef</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">b2CircleShape</span> <span class="n">shape</span><span class="p">;</span>
</span><span class='line'>    <span class="n">shape</span><span class="p">.</span><span class="n">m_radius</span> <span class="o">=</span> <span class="n">PointsToMeters</span><span class="p">(</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">b2FixtureDef</span> <span class="n">fixtureDef</span><span class="p">;</span>
</span><span class='line'>    <span class="n">fixtureDef</span><span class="p">.</span><span class="n">shape</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">shape</span><span class="p">;</span>
</span><span class='line'>    <span class="n">fixtureDef</span><span class="p">.</span><span class="n">density</span> <span class="o">=</span> <span class="mf">1.0f</span><span class="p">;</span>
</span><span class='line'>    <span class="n">fixtureDef</span><span class="p">.</span><span class="n">friction</span> <span class="o">=</span> <span class="mf">0.3f</span><span class="p">;</span>
</span><span class='line'>    <span class="n">fixtureDef</span><span class="p">.</span><span class="n">restitution</span> <span class="o">=</span> <span class="mf">0.8f</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">circle</span><span class="o">-&gt;</span><span class="n">CreateFixture</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fixtureDef</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// Associate the body with the passed in view</span>
</span><span class='line'>    <span class="n">circle</span><span class="o">-&gt;</span><span class="n">SetUserData</span><span class="p">((</span><span class="n">__bridge</span> <span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">view</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">[</span><span class="n">_circles</span> <span class="nl">addObject:</span><span class="p">[</span><span class="n">NSValue</span> <span class="nl">valueWithPointer:</span><span class="n">circle</span><span class="p">]];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we create a body with the same position as the view, we add it a circle shape that matches the size of the view and a few physical properties. Later on we&rsquo;ll need to know what view each body represents so we save the pointer to the view in the body&rsquo;s user data field.</p>

<p>Let&rsquo;s move on to setting up the animation loop:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setupAnimationLoop</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">CADisplayLink</span> <span class="o">*</span><span class="n">displayLink</span> <span class="o">=</span> <span class="p">[</span><span class="n">CADisplayLink</span> <span class="nl">displayLinkWithTarget:</span><span class="n">self</span> <span class="nl">selector:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">animationLoop:</span><span class="p">)];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">displayLink</span> <span class="nl">addToRunLoop:</span><span class="p">[</span><span class="n">NSRunLoop</span> <span class="n">mainRunLoop</span><span class="p">]</span> <span class="nl">forMode:</span><span class="n">NSDefaultRunLoopMode</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">animationLoop:</span><span class="p">(</span><span class="n">CADisplayLink</span><span class="o">*</span><span class="p">)</span><span class="nv">sender</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">CFTimeInterval</span> <span class="n">timeDelta</span> <span class="o">=</span> <span class="n">sender</span><span class="p">.</span><span class="n">duration</span> <span class="o">*</span> <span class="n">sender</span><span class="p">.</span><span class="n">frameInterval</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">int32</span> <span class="n">velocityIterations</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
</span><span class='line'>    <span class="n">int32</span> <span class="n">positionIterations</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">_world</span><span class="o">-&gt;</span><span class="n">Step</span><span class="p">(</span><span class="n">timeDelta</span><span class="p">,</span> <span class="n">velocityIterations</span><span class="p">,</span> <span class="n">positionIterations</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Adjust position for all views associated with circle bodies</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span><span class="n">NSValue</span> <span class="o">*</span><span class="n">circleWrapper</span> <span class="k">in</span> <span class="n">_circles</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">b2Body</span> <span class="o">*</span><span class="n">circle</span> <span class="o">=</span> <span class="p">(</span><span class="n">b2Body</span><span class="o">*</span><span class="p">)[</span><span class="n">circleWrapper</span> <span class="n">pointerValue</span><span class="p">];</span>
</span><span class='line'>        <span class="n">UIView</span> <span class="o">*</span><span class="n">view</span> <span class="o">=</span> <span class="p">(</span><span class="n">__bridge</span> <span class="n">UIView</span><span class="o">*</span><span class="p">)</span><span class="n">circle</span><span class="o">-&gt;</span><span class="n">GetUserData</span><span class="p">();</span>
</span><span class='line'>        <span class="n">view</span><span class="p">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">b2Vec2ToCGPoint</span><span class="p">(</span><span class="n">circle</span><span class="o">-&gt;</span><span class="n">GetPosition</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Animations are always computed in discreet time intervals called <em>frames</em>. Animations get more accurate as frames get shorter but since the amount of time required to compute a frame stays relatively constant you take a performance hit when animating in shorter frames. Displays however operate on a fixed frame rate. In the code above, <em>animationLoop:</em> is in charge of animating and drawing a frame on the screen. CADisplayLink is in charge of deciding when the screen is ready to draw something new and will call <em>animationLoop:</em> to do the drawing. It&rsquo;s entirely possible that <em>animationLoop:</em> would require more time to execute than a single screen refresh cycle, but what CADisplayLink ensures is that your animations stay as smooth as possible with the available resources and that no animation frames are being computed if the display is not ready to show them.</p>

<p>Let&rsquo;s look at <em>animationLoop:</em> in more detail. First thing it does is figure out how much time has passed since the last run and passes that info to our world object which will then proceed to update its internal state. There are two extra parameters there: <em>velocityIterations</em> and <em>positionIterations</em>. These have more to do with Box2D&rsquo;s inner workings. What happens is that Box2D approximates body velocity and position in multiple iterations. The more iterations you attempt, the more realistic the outcome. You can fine tune these values until you find something acceptable in terms of performance and realism.</p>

<p>Once Box2D does its thing, all we need to do is iterate over all circle bodies and update the position of their associated UIView to match the bodies&#8217; new positions.</p>

<p>Finally, we need to take care of the cleanup. The only C++ object we allocated ourselves is the world object. Everything else was allocated internally by Box2D and will be cleaned up once the world object is destroyed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">dealloc</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">delete</span> <span class="n">_world</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s it! If you followed all the steps you should end up with something like this:</p>

<div class="embed-video-container"><iframe src="http://www.youtube.com/embed/dxox7uz4Sas "></iframe></div>


<p>You can grab the full code for this tutorial from here: <a title="https://github.com/MihaiDamian/Box2DTutorial" href="https://github.com/MihaiDamian/Box2DTutorial" target="_blank"><a href="https://github.com/MihaiDamian/Box2DTutorial">https://github.com/MihaiDamian/Box2DTutorial</a></a></p>

<p>So there you have it. Physics engines can be used very easily in a UIKit based app. In fact you could even go and build a game like <a title="Hundreds on iTunes" href="https://itunes.apple.com/us/app/hundreds/id493536432?mt=8" target="_blank">Hundreds</a> using nothing but UIKit and Box2D.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Mihai Damian</span></span>

      




<time class='entry-date' datetime='2013-02-05T00:00:00+02:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>12:00 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/ios/'>ios</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://www.codesushi.net/blog/2013/02/physics-uikit-2/" data-via="" data-counturl="http://www.codesushi.net/blog/2013/02/physics-uikit-2/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
      
        <a class="basic-alignment right" href="/blog/2013/03/stackoverflow-tag-popularity-by-country/" title="Next Post: StackOverflow tag popularity by country">StackOverflow tag popularity by country &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/05/uiview-as-opengl-texture/">Using UIViews as OpenGL Textures for Custom View Controller Transitions</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/stackoverflow-tag-popularity-by-country/">StackOverflow Tag Popularity by Country</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/physics-uikit-2/">Using Physics in a UIKit Based Application</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Mihai Damian -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'codesushi';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.codesushi.net/blog/2013/02/physics-uikit-2/';
        var disqus_url = 'http://www.codesushi.net/blog/2013/02/physics-uikit-2/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
